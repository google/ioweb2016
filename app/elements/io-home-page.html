<!--
Copyright 2016 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<!-- <link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html"> -->

<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/google-youtube/google-youtube.html">

<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="social-poller.html">
<link rel="import" href="social-post.html">
<link rel="import" href="countdown-timer/countdown-timer.html">
<link rel="import" href="card-video.html">

<link rel="import" href="io-live.html">

<link rel="import" href="shared-app-styles.html">
<link rel="import" href="PageBehavior.html">


<dom-module id="io-home-page">
<template>
  <style include="shared-app-styles">
    :host {
      display: block;
    }
  </style>

  <io-live id="iolive"
           app="[[app]]"
           mode="{{liveModuleMode}}"
           date="[[date]]"
           sessions="[[app.scheduleData.sessions]]"
           speakers="[[app.scheduleData.speakers]]"
           user-sessions="[[app.savedSessions]]"
           social-posts="[[socialPosts]]"
           live-stream-channel-ids="[[_liveStreamChannelIds]]"
           auto-open-fab="[[app.splashRemoved]]"
           on-countdown-intro="_onIntro"
           fit>
    <h2>I/O is starting soon. #io16</h2>
  </io-live>

  <!-- TODO: comment out when io-live is up. -->
  <!-- <div layout horizontal end>
    <div id="countdown-container" class="card__container">
      <countdown-timer id="ctimer" date="[[date]]"
          on-countdown-intro="_onIntro"
          current-time="{{currentTime}}"
          aria-hidden="true"></countdown-timer>
    </div>
  </div> -->

  <div id="aria-countdown" role="timer">[[currentTime]]</div>

  <!-- <paper-toolbar class="navbar__overlay navbar__overlay--video"
                 aria-hidden$="{{!app.fullscreenVideoActive}}" fit>
    <paper-icon-button icon="io:arrow-back"
        on-tap="closeVideoCard"
        aria-label="Close video"
        tabindex$="[[_enableTabIndex(app.fullscreenVideoActive)]]"></paper-icon-button>
    <span flex>Watch the I/O 2015 Recap</span>
  </paper-toolbar> -->

  <!-- backdrop shouldn't be applied on ios - github.com/Polymer/paper-dialog/issues/16 -->
  <paper-dialog class="video_overlay-dialog"
                entry-animation="scale-up-animation"
                exit-animation="fade-out-animation"
                on-iron-overlay-closed="closeDialogVideo">
    <paper-icon-button icon="io:close" dialog-dismiss
                       aria-label="Close dialog"></paper-icon-button>
    <template is="dom-if" if="[[app.fullscreenVideoActive]]" restamp>
      <div class="fullvideo__container" fit>
        <google-youtube video-id="OT8wVt1Bt_Y" fit width="100%" height="100%"
            autohide="1" controls="2" modestbranding="1" showinfo="0"
            iv_load_policy="3" rel="0" autoplay="1"></google-youtube>
      </div>
    </template>
  </paper-dialog>

  <div class="active">

    <div class="card__container slide-up">

      <div class="card" layout horizontal wrap  vertical$="{{app.isPhoneSize}}">

        <div class="card-content box box-more-height-mobile card--top-left-clip bg-cyan-300" layout vertical>
          <h3 class="card__title">May 18&#8211;20, 2016</h3>
          <h3 class="card__sub-title">
            <a href="https://goo.gl/maps/7hs1NJR3ErG2" target="_blank"
               data-track-link="nav-shoreline-maps-link">
               <span>Shoreline Amphitheatre<br>Mountain View, California</span>
            </a>
          </h3>
          <div layout flex end>
            <div>
              <span class="notification__feature">
                <a href="#" data-track-link="home-reminder-button" on-click="_onSetReminder">
                  <paper-button class="reminder-button" noink tabindex="-1">Set a reminder</paper-button>
                </a>
              </span>
              <h5 style="font-weight:normal">Google I/O is for developers&#8212;the creative coders who are building what&#8217;s next. Together we&#8217;ll explore the latest in tech, mobile, and beyond.</h5>
            </div>
          </div>
        </div>
        <div class="card-content box card__photo card--top-right-clip" relative>
          <iron-pages id="photo_list" class="card--top-right-clip" on-transitionend="onTransitionEnd" selected="0" fit role="marquee" aria-label="image carousel">
            <img src="/io2016/images/home/cardboard.jpg" class="card--top-right-clip" style="visibility: visible;" alt="A man wearing headphones looks through a Google cardboard device">
            <img src="/io2016/images/home/keynote.jpg" class="card--top-right-clip" alt="A woman presents a keynote address on stage at Google I/O">
            <img src="/io2016/images/home/design.jpg" class="card--top-right-clip" alt="An audience sits on bean bag chairs watching a presentation on design">
            <img src="/io2016/images/home/hand.jpg" class="card--top-right-clip" alt="A woman is shown a demonstration of a robotic arm">
            <img src="/io2016/images/home/dj.jpg" class="card--top-right-clip" alt="A D.J. plays turntables in a booth with a large I/O logo">
          </iron-pages>
        </div>

        <div class="card-content box bg-bluegrey-50-30">
          <a href="/io2016/schedule" data-ajax-link
             data-track-link="home-schedule-learnmore" layout vertical>
            <h3 class="card__title">I/O Schedule</h3>
            <div>
              <h5 style="font-weight:normal">Browse the entire agenda and create your own custom schedule for I/O. Sign in to get notifications on your device.</h5>
            </div>
            <div layout flex end>
              <span class="card__footerlink" layout horiziontal justified center flex>
                View schedule
                <iron-icon icon="io:keyboard-arrow-right"></iron-icon>
              </span>
            </div>
          </a>
        </div>
        <div class="card-content box bg-bluegrey-50">
          <a href="/io2016/extended" data-ajax-link
             data-track-link="home-extended-learnmore" layout vertical>
            <h3 class="card__title">I/O Extended</h3>
            <div>
              <h5 style="font-weight:normal">Can&#8217;t make it to I/O this year? No problem, you can still make an event out of it.</h5>
            </div>
            <div layout flex end>
              <div class="card__footerlink" layout horiziontal justified center flex>
                Join from your location
                <iron-icon icon="io:keyboard-arrow-right"></iron-icon>
              </div>
            </div>
          </a>
        </div>

        <div class="card-content box bg-bluegrey-700 typo-white">
          <a href="/io2016/attend#travel" data-ajax-link
             data-track-link="home-attending-learnmore" layout vertical>
            <h3 class="card__title">Getting to I/O</h3>
            <div>
              <h5 style="font-weight:normal">There are plenty of ways to get to Mountain View, CA. Start planning your trip now.</h5>
            </div>
            <div layout flex end>
              <div class="card__footerlink" layout horiziontal justified center flex>
                View Travel Info
                <iron-icon icon="io:keyboard-arrow-right"></iron-icon>
              </div>
            </div>
          </a>
        </div>
        <div class="card-content box card__video fullbleed typo-white" layout vertical>
          <div class="card-content card__play-button card__photo photo__recap"
               style="height:100%"
               on-tap="openDialogVideo"
               on-keyup="checkOpenDialogVideo"
               data-track-link="home-watch-recap-video"
               role="button"
               tabindex="0"
               flex>
            <h5>Watch the I/O 2015 recap</h5>
          </div>
        </div>

        <div id="social_card"
             class="card-content box card--bottom-left-clip card--allow-a-wrap fullbleed typo-indigo-400 bg-bluegrey-50-20"
             on-mouseenter="stopTweetCycler"
             on-mouseleave="startTweetCycler">

          <!-- <template is="dom-if" if="[[_scrolledToBottomCards]]"> -->
            <social-poller url="/io2016/api/v1/social" posts="{{socialPosts}}"
                           interval="30000"></social-poller>

            <iron-pages id="social_list" selected="0" layout vertical role="marquee" aria-label="tweet carousel">
              <template is="dom-repeat" items="[[_limit(socialPosts, 5)]]" as="post">
                <social-post view="card"
                             kind="[[post.kind]]"
                             author="[[post.author]]"
                             url="[[post.url]]"
                             text="[[post.text]]"
                             when="[[post.when]]"
                             layout vertical flex
                             on-transitionend="onTransitionEnd">
                </social-post>
              </template>
            </iron-pages>
          <!-- </template> -->

        </div>
        <div class="card-content box card--bottom-right-clip fullbleed io__hash bg-bluegrey-50-40">
          <a href="https://twitter.com/search?q=%23io16" target="_blank" aria-label="Search #io16 on Twitter">
            <template is="dom-if" if="[[_loadVideo]]">
              <card-video id="card-video"
                  src="/io2016/videos/hashtag-800.mp4"
                  href="https://twitter.com/search?q=%23io16"
                  text="Search #io16 on Twitter"></card-video>
            </template>
          </a>
        </div>
      </div>
    </div>

  </div>

  <!-- <iron-scroll-threshold id="threshold" hidden
      lower-triggered="{{_scrolledToBottomCards}}"></iron-scroll-threshold> -->

</template>
<script>
(function () {
  'use strict';

  var _cycleSocialPostsInterval = null;
  var _cyclePhotosInterval = null;
  var SOCIAL_CYCLE = 5000;
  var PHOTOS_CYCLE = 4000;

  Polymer({
    is: 'io-home-page',

    behaviors: [IOBehaviors.PageBehavior],

    properties: {
      /**
       * The target date for I/O to start. Should be specified in ISO 8601
       * format, e.g. `May 18 2016 10:00:00 GMT-0700 (PDT)`.
       */
      date: {
        type: String,
        value: 'May 18 2016 10:00:00 GMT-0700 (PDT)'
      },

      /**
       * True when the user has scrolled down to the hash tag video section.
       */
      // _scrolledToBottomCards: {
      //   type: Boolean,
      //   value: false,
      //   observer: '_onScrolledBottomCards'
      // },

      _loadVideo: {
        type: Boolean,
        //computed: '_computeLoadVideo(app.isDesktopSize, app.pageTransitionDone, _scrolledToBottomCards)'
        computed: '_computeLoadVideo(app.isDesktopSize, app.pageTransitionDone, app.isIOS, app.isAndroid)'
      },

      _liveStreamChannelIds: {
        type: Array
      }
    },

    title: 'Google I/O 2016',
    name: 'home',

    attached: function() {
      // Reset template variables for when revisiting the page.
      this.set('app.fullscreenVideoActive', false);

      //this.$.threshold.scrollTarget = IOWA.Elements.ScrollContainer;

      // Calculate top of tweet cycler / hashtag video section.
      // this.$.threshold.lowerThreshold = IOWA.Elements.Footer.clientHeight +
      //     parseInt(getComputedStyle(IOWA.Elements.Footer).height) +
      //     Polymer.dom(this.root).querySelector('.card-content.box').clientHeight;

      if (this.app.isPhoneSize) {
        this.listen(IOWA.Elements.ScrollContainer, 'scroll', '_onPageScroll');
      }

      // Stop tweet cycler if focused, resume when blurred
      // Focus and blur events don't bubble so need to use capturing
      // event handlers.
      // Keep a reference to the bound functions around so we can clean them up
      // in detached
      this._stopTweetCycler = this.stopTweetCycler.bind(this);
      this._startTweetCycler = this.startTweetCycler.bind(this);

      this.$.social_card.addEventListener('focus', this._stopTweetCycler, true);
      this.$.social_card.addEventListener('blur', this._startTweetCycler, true);
    },

    detached: function() {
      this.stopTweetCycler();
      window.clearInterval(_cyclePhotosInterval);
      _cyclePhotosInterval = null;

      this.unlisten(IOWA.Elements.ScrollContainer, 'scroll', '_onPageScroll');

      this.$.social_card.removeEventListener(
          'focus', this._stopTweetCycler, true);
      this.$.social_card.removeEventListener(
          'blur', this._startTweetCycler, true);
    },

    onPageTransitionDone: function() {
      if (this.$.ctimer) {
        this.$.ctimer.start(); // Start countdown.
      }
      if (this.$.iolive) {
        this.$.iolive.startCountdown(); // Start io-live's countdown.
      }

      this.startTweetCycler();

      // Don't cycle photos on mobile.
      if (!this.app.isPhoneSize) {
        this._cyclePhotos();
      }
    },

    // _onScrolledBottomCards: function() {
    //   if (this._scrolledToBottomCards) {
    //     // Wait a bit for the template to have stamped the social stuff.
    //     this.async(function() {
    //       this.startTweetCycler();
    //     }, 10);
    //   }
    // },

    // Manage screen reader accessibility for offscreen carousel
    // images and social posts
    onTransitionEnd: function(e) {
      e.stopPropagation();
      var item = Polymer.dom(e).rootTarget;
      if (!item.classList.contains('iron-selected')) {
        item.style.visibility = 'hidden';
        return;
      }
    },

    startTweetCycler: function() {
      this._cycleSocialPosts();
    },

    stopTweetCycler: function() {
      window.clearInterval(_cycleSocialPostsInterval);
      _cycleSocialPostsInterval = null;
    },

    _onPageScroll: function() {
      if (this.$.ctimer) {
        this.$.ctimer.stop();

        this.debounce('enablecountdown', function() {
          this.$.ctimer.start();
        }, 250);
      }
    },

    _computeLoadVideo: function(isDesktopSize, pageTransitionDone, isIOS, isAndroid) {
      return isDesktopSize && pageTransitionDone && !isIOS && !isAndroid;
    },

    _onSetReminder: function(e, detail) {
      e.preventDefault();

      IOWA.Schedule.saveSession('__keynote__', true).then(function() {
        IOWA.Schedule.bookmarkSessionNotification(
            true, "You'll be reminded when I/O starts.");
      });
    },

    _cyclePhotos: function() {
      window.clearInterval(_cyclePhotosInterval);
      _cyclePhotosInterval = window.setInterval(function() {
        this.$.photo_list.selectNext();
        this.$.photo_list.selectedItem.style.visibility = 'visible';
      }.bind(this), PHOTOS_CYCLE);
    },

    _cycleSocialPosts: function() {
      window.clearInterval(_cycleSocialPostsInterval);

      var socialList = this.$.social_card.querySelector('#social_list');

      var forceVisible = function() {
        // Force initial item to visible
        if (socialList.selectedItem) {
          socialList.selectedItem.style.visibility = 'visible';
        } else {
          socialList.children[0].style.visibility = 'visible';
        }
      };

      forceVisible();

      _cycleSocialPostsInterval = window.setInterval(function() {
        socialList.selectNext();
        // There appears to be a race condition that leads to
        // socialList.selectedItem being undefined following
        // socialList.selectNext().
        // See https://github.com/GoogleChrome/ioweb2016/issues/409
        // Use the forceVisible() helper to work around that bug.
        forceVisible();
      }.bind(this), SOCIAL_CYCLE);
    },

    _onIntro: function(e, detail) {
      e.stopPropagation();
      var logo = IOWA.Elements.Nav.querySelector('.io-logo');
      if (detail.start) {
        logo.classList.remove('active');
      } else if (detail.done) {
        logo.classList.add('active');
      }
    }
  });

}());
</script>
</dom-module>
